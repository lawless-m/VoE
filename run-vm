#!/bin/bash

# run-vm - Start a VM with iSCSI port forwarding for testing
# Usage: ./run-vm [disk-image]

set -e

DISK_IMAGE="${1:-/tmp/test-vm.qcow2}"
MEMORY="${MEMORY:-2048}"
SSH_PORT="${SSH_PORT:-2222}"
ISCSI_PORT="${ISCSI_PORT:-3260}"

# Create a test disk if it doesn't exist
if [ ! -f "$DISK_IMAGE" ]; then
    echo "Creating test disk image: $DISK_IMAGE"
    qemu-img create -f qcow2 "$DISK_IMAGE" 20G
fi

echo "Starting VM with:"
echo "  Disk: $DISK_IMAGE"
echo "  Memory: ${MEMORY}M"
echo "  SSH port forwarding: localhost:$SSH_PORT -> VM:22"
echo "  iSCSI port forwarding: VM:3260 -> host:$ISCSI_PORT"
echo ""
echo "Connect to iSCSI target from VM using host IP: 10.0.2.2:3260"
echo "SSH into VM: ssh -p $SSH_PORT user@localhost"
echo ""

exec qemu-system-x86_64 \
    -enable-kvm \
    -m "$MEMORY" \
    -cpu host \
    -smp 2 \
    -drive file="$DISK_IMAGE",format=qcow2,if=virtio \
    -netdev user,id=net0,hostfwd=tcp::${SSH_PORT}-:22,hostfwd=tcp:10.0.2.2:${ISCSI_PORT}-:${ISCSI_PORT} \
    -device virtio-net-pci,netdev=net0 \
    -nographic \
    "$@"
